import { Injectable } from '@angular/core';
import { forkJoin, from, of } from 'rxjs';
import { first, mergeMap, tap } from 'rxjs/operators';
import { DEFAULT_REDIRECT_KEY } from '../model/permissions-router-data.model';
import { isFunction, isPlainObject, transformStringToArray } from '../utils/utils';
import * as i0 from "@angular/core";
import * as i1 from "../service/permissions.service";
import * as i2 from "../service/roles.service";
import * as i3 from "@angular/router";
export class NgxPermissionsGuard {
    constructor(permissionsService, rolesService, router) {
        this.permissionsService = permissionsService;
        this.rolesService = rolesService;
        this.router = router;
    }
    canActivate(route, state) {
        return this.hasPermissions(route, state);
    }
    canActivateChild(childRoute, state) {
        return this.hasPermissions(childRoute, state);
    }
    canLoad(route) {
        return this.hasPermissions(route);
    }
    hasPermissions(route, state) {
        const routeDataPermissions = !!route && route.data ? route.data['permissions'] : {};
        const permissions = this.transformPermission(routeDataPermissions, route, state);
        if (this.isParameterAvailable(permissions.except)) {
            return this.passingExceptPermissionsValidation(permissions, route, state);
        }
        if (this.isParameterAvailable(permissions.only)) {
            return this.passingOnlyPermissionsValidation(permissions, route, state);
        }
        return true;
    }
    transformPermission(permissions, route, state) {
        const only = isFunction(permissions.only)
            ? permissions.only(route, state)
            : transformStringToArray(permissions.only);
        const except = isFunction(permissions.except)
            ? permissions.except(route, state)
            : transformStringToArray(permissions.except);
        const redirectTo = permissions.redirectTo;
        return {
            only,
            except,
            redirectTo
        };
    }
    isParameterAvailable(permission) {
        return !!permission && permission.length > 0;
    }
    passingExceptPermissionsValidation(permissions, route, state) {
        if (!!permissions.redirectTo
            && ((isFunction(permissions.redirectTo))
                || (isPlainObject(permissions.redirectTo) && !this.isRedirectionWithParameters(permissions.redirectTo)))) {
            let failedPermission = '';
            return from(permissions.except)
                .pipe(mergeMap(permissionsExcept => {
                return forkJoin([
                    this.permissionsService.hasPermission(permissionsExcept),
                    this.rolesService.hasOnlyRoles(permissionsExcept)
                ]).pipe(tap(hasPermissions => {
                    const dontHavePermissions = hasPermissions.every(hasPermission => hasPermission === false);
                    if (!dontHavePermissions) {
                        failedPermission = permissionsExcept;
                    }
                }));
            }), first(hasPermissions => hasPermissions.some(hasPermission => hasPermission === true), false), mergeMap(isAllFalse => {
                if (!!failedPermission) {
                    this.handleRedirectOfFailedPermission(permissions, failedPermission, route, state);
                    return of(false);
                }
                if (!isAllFalse && permissions.only) {
                    return this.onlyRedirectCheck(permissions, route, state);
                }
                return of(!isAllFalse);
            }))
                .toPromise();
        }
        return Promise.all([
            this.permissionsService.hasPermission(permissions.except),
            this.rolesService.hasOnlyRoles(permissions.except)
        ]).then(([hasPermission, hasRoles]) => {
            if (hasPermission || hasRoles) {
                if (permissions.redirectTo) {
                    this.redirectToAnotherRoute(permissions.redirectTo, route, state);
                }
                return false;
            }
            if (permissions.only) {
                return this.checkOnlyPermissions(permissions, route, state);
            }
            return true;
        });
    }
    redirectToAnotherRoute(permissionRedirectTo, route, state, failedPermissionName) {
        const redirectTo = isFunction(permissionRedirectTo)
            ? permissionRedirectTo(failedPermissionName, route, state)
            : permissionRedirectTo;
        if (this.isRedirectionWithParameters(redirectTo)) {
            redirectTo.navigationCommands = this.transformNavigationCommands(redirectTo.navigationCommands, route, state);
            redirectTo.navigationExtras = this.transformNavigationExtras(redirectTo.navigationExtras, route, state);
            this.router.navigate(redirectTo.navigationCommands, redirectTo.navigationExtras);
            return;
        }
        if (Array.isArray(redirectTo)) {
            this.router.navigate(redirectTo);
        }
        else {
            this.router.navigate([redirectTo]);
        }
    }
    isRedirectionWithParameters(object) {
        return (isPlainObject(object) && (!!object.navigationCommands || !!object.navigationExtras));
    }
    transformNavigationCommands(navigationCommands, route, state) {
        return isFunction(navigationCommands)
            ? navigationCommands(route, state)
            : navigationCommands;
    }
    transformNavigationExtras(navigationExtras, route, state) {
        return isFunction(navigationExtras)
            ? navigationExtras(route, state)
            : navigationExtras;
    }
    onlyRedirectCheck(permissions, route, state) {
        let failedPermission = '';
        return from(permissions.only)
            .pipe(mergeMap(permissionsOnly => {
            return forkJoin([
                this.permissionsService.hasPermission(permissionsOnly),
                this.rolesService.hasOnlyRoles(permissionsOnly)
            ]).pipe(tap(hasPermissions => {
                const failed = hasPermissions.every(hasPermission => hasPermission === false);
                if (failed) {
                    failedPermission = permissionsOnly;
                }
            }));
        }), first(hasPermissions => {
            if (isFunction(permissions.redirectTo)) {
                return hasPermissions.some(hasPermission => hasPermission === true);
            }
            return hasPermissions.every(hasPermission => hasPermission === false);
        }, false), mergeMap((pass) => {
            if (isFunction(permissions.redirectTo)) {
                if (pass) {
                    return of(true);
                }
                else {
                    this.handleRedirectOfFailedPermission(permissions, failedPermission, route, state);
                    return of(false);
                }
            }
            else {
                if (!!failedPermission) {
                    this.handleRedirectOfFailedPermission(permissions, failedPermission, route, state);
                }
                return of(!pass);
            }
        }))
            .toPromise();
    }
    handleRedirectOfFailedPermission(permissions, failedPermission, route, state) {
        if (this.isFailedPermissionPropertyOfRedirectTo(permissions, failedPermission)) {
            this.redirectToAnotherRoute(permissions.redirectTo[failedPermission], route, state, failedPermission);
        }
        else {
            if (isFunction(permissions.redirectTo)) {
                this.redirectToAnotherRoute(permissions.redirectTo, route, state, failedPermission);
            }
            else {
                this.redirectToAnotherRoute(permissions.redirectTo[DEFAULT_REDIRECT_KEY], route, state, failedPermission);
            }
        }
    }
    isFailedPermissionPropertyOfRedirectTo(permissions, failedPermission) {
        return (!!permissions.redirectTo && permissions.redirectTo[failedPermission]);
    }
    checkOnlyPermissions(purePermissions, route, state) {
        const permissions = {
            ...purePermissions
        };
        return Promise.all([
            this.permissionsService.hasPermission(permissions.only),
            this.rolesService.hasOnlyRoles(permissions.only)
        ]).then(([hasPermission, hasRole]) => {
            if (hasPermission || hasRole) {
                return true;
            }
            if (permissions.redirectTo) {
                this.redirectToAnotherRoute(permissions.redirectTo, route, state);
            }
            return false;
        });
    }
    passingOnlyPermissionsValidation(permissions, route, state) {
        if ((isFunction(permissions.redirectTo)
            || isPlainObject(permissions.redirectTo) && !this.isRedirectionWithParameters(permissions.redirectTo))) {
            return this.onlyRedirectCheck(permissions, route, state);
        }
        return this.checkOnlyPermissions(permissions, route, state);
    }
}
NgxPermissionsGuard.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.2", ngImport: i0, type: NgxPermissionsGuard, deps: [{ token: i1.NgxPermissionsService }, { token: i2.NgxRolesService }, { token: i3.Router }], target: i0.ɵɵFactoryTarget.Injectable });
NgxPermissionsGuard.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.2.2", ngImport: i0, type: NgxPermissionsGuard });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.2", ngImport: i0, type: NgxPermissionsGuard, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.NgxPermissionsService }, { type: i2.NgxRolesService }, { type: i3.Router }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVybWlzc2lvbnMtZ3VhcmQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1wZXJtaXNzaW9ucy9zcmMvbGliL3JvdXRlci9wZXJtaXNzaW9ucy1ndWFyZC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFZM0MsT0FBTyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RELE9BQU8sRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXRELE9BQU8sRUFDSCxvQkFBb0IsRUFTdkIsTUFBTSx3Q0FBd0MsQ0FBQztBQUdoRCxPQUFPLEVBQUUsVUFBVSxFQUFFLGFBQWEsRUFBRSxzQkFBc0IsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7OztBQVNuRixNQUFNLE9BQU8sbUJBQW1CO0lBRTVCLFlBQW9CLGtCQUF5QyxFQUFVLFlBQTZCLEVBQVUsTUFBYztRQUF4Ryx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQXVCO1FBQVUsaUJBQVksR0FBWixZQUFZLENBQWlCO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBUTtJQUM1SCxDQUFDO0lBRUQsV0FBVyxDQUFDLEtBQTZCLEVBQUUsS0FBMEI7UUFDakUsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRUQsZ0JBQWdCLENBQUMsVUFBa0MsRUFBRSxLQUEwQjtRQUMzRSxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ2xELENBQUM7SUFFRCxPQUFPLENBQUMsS0FBWTtRQUNoQixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDdEMsQ0FB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WUFDakMsSUFBSSxhQUFhLElBQUksT0FBTyxFQUFFO2dCQUMxQixPQUFPLElBQUksQ0FBQzthQUNmO1lBRUQsSUFBSSxXQUFXLENBQUMsVUFBVSxFQUFFO2dCQUN4QixJQUFJLENBQUMsc0JBQXNCLENBQUMsV0FBVyxDQUFDLFVBQVUsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7YUFDckU7WUFFRCxPQUFPLEtBQUssQ0FBQztRQUNqQixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTyxnQ0FBZ0MsQ0FDcEMsV0FBK0IsRUFDL0IsS0FBcUMsRUFDckMsS0FBMkI7UUFFM0IsSUFDSSxDQUFDLFVBQVUsQ0FBZSxXQUFXLENBQUMsVUFBVSxDQUFDO2VBQzFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsMkJBQTJCLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFDLEVBQzVHO1lBQ0UsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsV0FBVyxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztTQUM1RDtRQUNELE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDLFdBQVcsRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDaEUsQ0FBQzs7Z0hBL1JRLG1CQUFtQjtvSEFBbkIsbUJBQW1COzJGQUFuQixtQkFBbUI7a0JBRC9CLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICAgIEFjdGl2YXRlZFJvdXRlU25hcHNob3QsXG4gICAgQ2FuQWN0aXZhdGUsXG4gICAgQ2FuQWN0aXZhdGVDaGlsZCxcbiAgICBDYW5Mb2FkLFxuICAgIE5hdmlnYXRpb25FeHRyYXMsXG4gICAgUm91dGUsXG4gICAgUm91dGVyLFxuICAgIFJvdXRlclN0YXRlU25hcHNob3Rcbn0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcblxuaW1wb3J0IHsgZm9ya0pvaW4sIGZyb20sIE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaXJzdCwgbWVyZ2VNYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHtcbiAgICBERUZBVUxUX1JFRElSRUNUX0tFWSxcbiAgICBFeGNlcHRGbixcbiAgICBOYXZpZ2F0aW9uQ29tbWFuZHNGbixcbiAgICBOYXZpZ2F0aW9uRXh0cmFzRm4sXG4gICAgTmd4UGVybWlzc2lvbnNSb3V0ZXJEYXRhLFxuICAgIE5neFJlZGlyZWN0VG9OYXZpZ2F0aW9uUGFyYW1ldGVycyxcbiAgICBPbmx5Rm4sXG4gICAgUmVkaXJlY3RUbyxcbiAgICBSZWRpcmVjdFRvRm5cbn0gZnJvbSAnLi4vbW9kZWwvcGVybWlzc2lvbnMtcm91dGVyLWRhdGEubW9kZWwnO1xuaW1wb3J0IHsgTmd4UGVybWlzc2lvbnNTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZS9wZXJtaXNzaW9ucy5zZXJ2aWNlJztcbmltcG9ydCB7IE5neFJvbGVzU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2Uvcm9sZXMuc2VydmljZSc7XG5pbXBvcnQgeyBpc0Z1bmN0aW9uLCBpc1BsYWluT2JqZWN0LCB0cmFuc2Zvcm1TdHJpbmdUb0FycmF5IH0gZnJvbSAnLi4vdXRpbHMvdXRpbHMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIE5neFBlcm1pc3Npb25zRGF0YSB7XG4gICAgb25seT86IHN0cmluZyB8IHN0cmluZ1tdO1xuICAgIGV4Y2VwdD86IHN0cmluZyB8IHN0cmluZ1tdO1xuICAgIHJlZGlyZWN0VG8/OiBSZWRpcmVjdFRvIHwgUmVkaXJlY3RUb0ZuO1xufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTmd4UGVybWlzc2lvbnNHdWFyZCBpbXBsZW1lbnRzIENhbkFjdGl2YXRlLCBDYW5Mb2FkLCBDYW5BY3RpdmF0ZUNoaWxkIHtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcGVybWlzc2lvbnNTZXJ2aWNlOiBOZ3hQZXJtaXNzaW9uc1NlcnZpY2UsIHByaXZhdGUgcm9sZXNTZXJ2aWNlOiBOZ3hSb2xlc1NlcnZpY2UsIHByaXZhdGUgcm91dGVyOiBSb3V0ZXIpIHtcbiAgICB9XG5cbiAgICBjYW5BY3RpdmF0ZShyb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCwgc3RhdGU6IFJvdXRlclN0YXRlU25hcHNob3QpOiBQcm9taXNlPGJvb2xlYW4+IHwgYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhc1Blcm1pc3Npb25zKHJvdXRlLCBzdGF0ZSk7XG4gICAgfVxuXG4gICAgY2FuQWN0aXZhdGVDaGlsZChjaGlsZFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LCBzdGF0ZTogUm91dGVyU3RhdGVTbmFwc2hvdCk6IE9ic2VydmFibGU8Ym9vbGVhbj4gfCBQcm9taXNlPGJvb2xlYW4+IHwgYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhc1Blcm1pc3Npb25zKGNoaWxkUm91dGUsIHN0YXRlKTtcbiAgICB9XG5cbiAgICBjYW5Mb2FkKHJvdXRlOiBSb3V0ZSk6IGJvb2xlYW4gfCBPYnNlcnZhYmxlPGJvb2xlYW4+IHwgUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhc1Blcm1pc3Npb25zKHJvdXRlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhc1Blcm1pc3Npb25zKHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90IHwgUm91dGUsIHN0YXRlPzogUm91dGVyU3RhdGVTbmFwc2hvdCkge1xuICAgICAgICBjb25zdCByb3V0ZURhdGFQZXJtaXNzaW9ucyA9ICEhcm91dGUgJiYgcm91dGUuZGF0YSA/IChyb3V0ZS5kYXRhWydwZXJtaXNzaW9ucyddIGFzIE5neFBlcm1pc3Npb25zUm91dGVyRGF0YSkgOiB7fTtcbiAgICAgICAgY29uc3QgcGVybWlzc2lvbnMgPSB0aGlzLnRyYW5zZm9ybVBlcm1pc3Npb24ocm91dGVEYXRhUGVybWlzc2lvbnMsIHJvdXRlLCBzdGF0ZSk7XG5cbiAgICAgICAgaWYgKHRoaXMuaXNQYXJhbWV0ZXJBdmFpbGFibGUocGVybWlzc2lvbnMuZXhjZXB0KSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMucGFzc2luZ0V4Y2VwdFBlcm1pc3Npb25zVmFsaWRhdGlvbihwZXJtaXNzaW9ucywgcm91dGUsIHN0YXRlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmlzUGFyYW1ldGVyQXZhaWxhYmxlKHBlcm1pc3Npb25zLm9ubHkpKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5wYXNzaW5nT25seVBlcm1pc3Npb25zVmFsaWRhdGlvbihwZXJtaXNzaW9ucywgcm91dGUsIHN0YXRlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIHByaXZhdGUgdHJhbnNmb3JtUGVybWlzc2lvbihcbiAgICAgICAgcGVybWlzc2lvbnM6IE5neFBlcm1pc3Npb25zUm91dGVyRGF0YSxcbiAgICAgICAgcm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QgfCBSb3V0ZSxcbiAgICAgICAgc3RhdGU/OiBSb3V0ZXJTdGF0ZVNuYXBzaG90XG4gICAgKTogTmd4UGVybWlzc2lvbnNEYXRhIHtcbiAgICAgICAgY29uc3Qgb25seSA9IGlzRnVuY3Rpb248T25seUZuPihwZXJtaXNzaW9ucy5vbmx5KVxuICAgICAgICAgICAgPyBwZXJtaXNzaW9ucy5vbmx5KHJvdXRlLCBzdGF0ZSlcbiAgICAgICAgICAgIDogdHJhbnNmb3JtU3RyaW5nVG9BcnJheShwZXJtaXNzaW9ucy5vbmx5KTtcbiAgICAgICAgY29uc3QgZXhjZXB0ID0gaXNGdW5jdGlvbjxFeGNlcHRGbj4ocGVybWlzc2lvbnMuZXhjZXB0KVxuICAgICAgICAgICAgPyBwZXJtaXNzaW9ucy5leGNlcHQocm91dGUsIHN0YXRlKVxuICAgICAgICAgICAgOiB0cmFuc2Zvcm1TdHJpbmdUb0FycmF5KHBlcm1pc3Npb25zLmV4Y2VwdCk7XG4gICAgICAgIGNvbnN0IHJlZGlyZWN0VG8gPSBwZXJtaXNzaW9ucy5yZWRpcmVjdFRvO1xuXG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIG9ubHksXG4gICAgICAgICAgICBleGNlcHQsXG4gICAgICAgICAgICByZWRpcmVjdFRvXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpc1BhcmFtZXRlckF2YWlsYWJsZShwZXJtaXNzaW9uOiBzdHJpbmcgfCBzdHJpbmdbXSkge1xuICAgICAgICByZXR1cm4gISFwZXJtaXNzaW9uICYmIHBlcm1pc3Npb24ubGVuZ3RoID4gMDtcbiAgICB9XG5cbiAgICBwcml2YXRlIHBhc3NpbmdFeGNlcHRQZXJtaXNzaW9uc1ZhbGlkYXRpb24oXG4gICAgICAgIHBlcm1pc3Npb25zOiBOZ3hQZXJtaXNzaW9uc0RhdGEsXG4gICAgICAgIHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90IHwgUm91dGUsXG4gICAgICAgIHN0YXRlOiBSb3V0ZXJTdGF0ZVNuYXBzaG90XG4gICAgKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICAgICEhcGVybWlzc2lvbnMucmVkaXJlY3RUb1xuICAgICAgICAgICAgJiYgKFxuICAgICAgICAgICAgICAgIChpc0Z1bmN0aW9uPFJlZGlyZWN0VG9Gbj4ocGVybWlzc2lvbnMucmVkaXJlY3RUbykpXG4gICAgICAgICAgICAgICAgfHwgKGlzUGxhaW5PYmplY3QocGVybWlzc2lvbnMucmVkaXJlY3RUbykgJiYgIXRoaXMuaXNSZWRpcmVjdGlvbldpdGhQYXJhbWV0ZXJzKHBlcm1pc3Npb25zLnJlZGlyZWN0VG8pKVxuICAgICAgICAgICAgKVxuICAgICAgICApIHtcbiAgICAgICAgICAgIGxldCBmYWlsZWRQZXJtaXNzaW9uID0gJyc7XG5cbiAgICAgICAgICAgIHJldHVybiBmcm9tKHBlcm1pc3Npb25zLmV4Y2VwdClcbiAgICAgICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICAgICAgbWVyZ2VNYXAocGVybWlzc2lvbnNFeGNlcHQgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZvcmtKb2luKFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBlcm1pc3Npb25zU2VydmljZS5oYXNQZXJtaXNzaW9uKHBlcm1pc3Npb25zRXhjZXB0KSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJvbGVzU2VydmljZS5oYXNPbmx5Um9sZXMocGVybWlzc2lvbnNFeGNlcHQpXG4gICAgICAgICAgICAgICAgICAgICAgICBdKS5waXBlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcChoYXNQZXJtaXNzaW9ucyA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRvbnRIYXZlUGVybWlzc2lvbnMgPSBoYXNQZXJtaXNzaW9ucy5ldmVyeShoYXNQZXJtaXNzaW9uID0+IGhhc1Blcm1pc3Npb24gPT09IGZhbHNlKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWRvbnRIYXZlUGVybWlzc2lvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZFBlcm1pc3Npb24gPSBwZXJtaXNzaW9uc0V4Y2VwdDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICAgICAgZmlyc3QoaGFzUGVybWlzc2lvbnMgPT4gaGFzUGVybWlzc2lvbnMuc29tZShoYXNQZXJtaXNzaW9uID0+IGhhc1Blcm1pc3Npb24gPT09IHRydWUpLCBmYWxzZSksXG4gICAgICAgICAgICAgICAgICAgIG1lcmdlTWFwKGlzQWxsRmFsc2UgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEhZmFpbGVkUGVybWlzc2lvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlUmVkaXJlY3RPZkZhaWxlZFBlcm1pc3Npb24ocGVybWlzc2lvbnMsIGZhaWxlZFBlcm1pc3Npb24sIHJvdXRlLCBzdGF0ZSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzQWxsRmFsc2UgJiYgcGVybWlzc2lvbnMub25seSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm9ubHlSZWRpcmVjdENoZWNrKHBlcm1pc3Npb25zLCByb3V0ZSwgc3RhdGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoIWlzQWxsRmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAudG9Qcm9taXNlKCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgdGhpcy5wZXJtaXNzaW9uc1NlcnZpY2UuaGFzUGVybWlzc2lvbihwZXJtaXNzaW9ucy5leGNlcHQpLFxuICAgICAgICAgICAgdGhpcy5yb2xlc1NlcnZpY2UuaGFzT25seVJvbGVzKHBlcm1pc3Npb25zLmV4Y2VwdClcbiAgICAgICAgXSkudGhlbigoW2hhc1Blcm1pc3Npb24sIGhhc1JvbGVzXSkgPT4ge1xuICAgICAgICAgICAgaWYgKGhhc1Blcm1pc3Npb24gfHwgaGFzUm9sZXMpIHtcbiAgICAgICAgICAgICAgICBpZiAocGVybWlzc2lvbnMucmVkaXJlY3RUbykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlZGlyZWN0VG9Bbm90aGVyUm91dGUoXG4gICAgICAgICAgICAgICAgICAgICAgICBwZXJtaXNzaW9ucy5yZWRpcmVjdFRvLFxuICAgICAgICAgICAgICAgICAgICAgICAgcm91dGUsXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZVxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHBlcm1pc3Npb25zLm9ubHkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jaGVja09ubHlQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucywgcm91dGUsIHN0YXRlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlZGlyZWN0VG9Bbm90aGVyUm91dGUoXG4gICAgICAgIHBlcm1pc3Npb25SZWRpcmVjdFRvOiBSZWRpcmVjdFRvIHwgUmVkaXJlY3RUb0ZuLFxuICAgICAgICByb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCB8IFJvdXRlLFxuICAgICAgICBzdGF0ZT86IFJvdXRlclN0YXRlU25hcHNob3QsXG4gICAgICAgIGZhaWxlZFBlcm1pc3Npb25OYW1lPzogc3RyaW5nXG4gICAgKTogdm9pZCB7XG5cbiAgICAgICAgY29uc3QgcmVkaXJlY3RUbyA9IGlzRnVuY3Rpb248UmVkaXJlY3RUb0ZuPihwZXJtaXNzaW9uUmVkaXJlY3RUbylcbiAgICAgICAgICAgID8gcGVybWlzc2lvblJlZGlyZWN0VG8oZmFpbGVkUGVybWlzc2lvbk5hbWUsIHJvdXRlLCBzdGF0ZSlcbiAgICAgICAgICAgIDogcGVybWlzc2lvblJlZGlyZWN0VG87XG5cbiAgICAgICAgaWYgKHRoaXMuaXNSZWRpcmVjdGlvbldpdGhQYXJhbWV0ZXJzKHJlZGlyZWN0VG8pKSB7XG4gICAgICAgICAgICByZWRpcmVjdFRvLm5hdmlnYXRpb25Db21tYW5kcyA9IHRoaXMudHJhbnNmb3JtTmF2aWdhdGlvbkNvbW1hbmRzKHJlZGlyZWN0VG8ubmF2aWdhdGlvbkNvbW1hbmRzLCByb3V0ZSwgc3RhdGUpO1xuICAgICAgICAgICAgcmVkaXJlY3RUby5uYXZpZ2F0aW9uRXh0cmFzID0gdGhpcy50cmFuc2Zvcm1OYXZpZ2F0aW9uRXh0cmFzKHJlZGlyZWN0VG8ubmF2aWdhdGlvbkV4dHJhcywgcm91dGUsIHN0YXRlKTtcbiAgICAgICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKHJlZGlyZWN0VG8ubmF2aWdhdGlvbkNvbW1hbmRzLCByZWRpcmVjdFRvLm5hdmlnYXRpb25FeHRyYXMpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkocmVkaXJlY3RUbykpIHtcbiAgICAgICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKHJlZGlyZWN0VG8pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoW3JlZGlyZWN0VG9dKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgaXNSZWRpcmVjdGlvbldpdGhQYXJhbWV0ZXJzKG9iamVjdDogYW55IHwgTmd4UmVkaXJlY3RUb05hdmlnYXRpb25QYXJhbWV0ZXJzKTogb2JqZWN0IGlzIE5neFJlZGlyZWN0VG9OYXZpZ2F0aW9uUGFyYW1ldGVycyB7XG4gICAgICAgIHJldHVybiAoaXNQbGFpbk9iamVjdChvYmplY3QpICYmICghIW9iamVjdC5uYXZpZ2F0aW9uQ29tbWFuZHMgfHwgISFvYmplY3QubmF2aWdhdGlvbkV4dHJhcykpO1xuICAgIH1cblxuICAgIHByaXZhdGUgdHJhbnNmb3JtTmF2aWdhdGlvbkNvbW1hbmRzKFxuICAgICAgICBuYXZpZ2F0aW9uQ29tbWFuZHM6IGFueVtdIHwgTmF2aWdhdGlvbkNvbW1hbmRzRm4sXG4gICAgICAgIHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90IHwgUm91dGUsXG4gICAgICAgIHN0YXRlPzogUm91dGVyU3RhdGVTbmFwc2hvdFxuICAgICk6IGFueVtdIHtcbiAgICAgICAgcmV0dXJuIGlzRnVuY3Rpb248TmF2aWdhdGlvbkNvbW1hbmRzRm4+KG5hdmlnYXRpb25Db21tYW5kcylcbiAgICAgICAgICAgID8gbmF2aWdhdGlvbkNvbW1hbmRzKHJvdXRlLCBzdGF0ZSlcbiAgICAgICAgICAgIDogbmF2aWdhdGlvbkNvbW1hbmRzO1xuICAgIH1cblxuICAgIHByaXZhdGUgdHJhbnNmb3JtTmF2aWdhdGlvbkV4dHJhcyhcbiAgICAgICAgbmF2aWdhdGlvbkV4dHJhczogTmF2aWdhdGlvbkV4dHJhcyB8IE5hdmlnYXRpb25FeHRyYXNGbixcbiAgICAgICAgcm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QgfCBSb3V0ZSxcbiAgICAgICAgc3RhdGU/OiBSb3V0ZXJTdGF0ZVNuYXBzaG90XG4gICAgKTogTmF2aWdhdGlvbkV4dHJhcyB7XG4gICAgICAgIHJldHVybiBpc0Z1bmN0aW9uPE5hdmlnYXRpb25FeHRyYXNGbj4obmF2aWdhdGlvbkV4dHJhcylcbiAgICAgICAgICAgID8gbmF2aWdhdGlvbkV4dHJhcyhyb3V0ZSwgc3RhdGUpXG4gICAgICAgICAgICA6IG5hdmlnYXRpb25FeHRyYXM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbmx5UmVkaXJlY3RDaGVjayhcbiAgICAgICAgcGVybWlzc2lvbnM6IE5neFBlcm1pc3Npb25zRGF0YSxcbiAgICAgICAgcm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QgfCBSb3V0ZSxcbiAgICAgICAgc3RhdGU/OiBSb3V0ZXJTdGF0ZVNuYXBzaG90XG4gICAgKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIGxldCBmYWlsZWRQZXJtaXNzaW9uID0gJyc7XG5cbiAgICAgICAgcmV0dXJuIGZyb20ocGVybWlzc2lvbnMub25seSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1lcmdlTWFwKHBlcm1pc3Npb25zT25seSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmb3JrSm9pbihbXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBlcm1pc3Npb25zU2VydmljZS5oYXNQZXJtaXNzaW9uKHBlcm1pc3Npb25zT25seSksXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJvbGVzU2VydmljZS5oYXNPbmx5Um9sZXMocGVybWlzc2lvbnNPbmx5KVxuICAgICAgICAgICAgICAgICAgICBdKS5waXBlKFxuICAgICAgICAgICAgICAgICAgICAgICAgdGFwKGhhc1Blcm1pc3Npb25zID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmYWlsZWQgPSBoYXNQZXJtaXNzaW9ucy5ldmVyeShoYXNQZXJtaXNzaW9uID0+IGhhc1Blcm1pc3Npb24gPT09IGZhbHNlKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmYWlsZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkUGVybWlzc2lvbiA9IHBlcm1pc3Npb25zT25seTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIGZpcnN0KGhhc1Blcm1pc3Npb25zID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uPFJlZGlyZWN0VG9Gbj4ocGVybWlzc2lvbnMucmVkaXJlY3RUbykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGFzUGVybWlzc2lvbnMuc29tZShoYXNQZXJtaXNzaW9uID0+IGhhc1Blcm1pc3Npb24gPT09IHRydWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGFzUGVybWlzc2lvbnMuZXZlcnkoaGFzUGVybWlzc2lvbiA9PiBoYXNQZXJtaXNzaW9uID09PSBmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIGZhbHNlKSxcbiAgICAgICAgICAgICAgICBtZXJnZU1hcChcbiAgICAgICAgICAgICAgICAgICAgKHBhc3M6IGJvb2xlYW4pOiBPYnNlcnZhYmxlPGJvb2xlYW4+ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uPFJlZGlyZWN0VG9Gbj4ocGVybWlzc2lvbnMucmVkaXJlY3RUbykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFzcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVSZWRpcmVjdE9mRmFpbGVkUGVybWlzc2lvbihwZXJtaXNzaW9ucywgZmFpbGVkUGVybWlzc2lvbiwgcm91dGUsIHN0YXRlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghIWZhaWxlZFBlcm1pc3Npb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVSZWRpcmVjdE9mRmFpbGVkUGVybWlzc2lvbihwZXJtaXNzaW9ucywgZmFpbGVkUGVybWlzc2lvbiwgcm91dGUsIHN0YXRlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKCFwYXNzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIC50b1Byb21pc2UoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZVJlZGlyZWN0T2ZGYWlsZWRQZXJtaXNzaW9uKFxuICAgICAgICBwZXJtaXNzaW9uczogTmd4UGVybWlzc2lvbnNEYXRhLFxuICAgICAgICBmYWlsZWRQZXJtaXNzaW9uOiBzdHJpbmcsXG4gICAgICAgIHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90IHwgUm91dGUsXG4gICAgICAgIHN0YXRlPzogUm91dGVyU3RhdGVTbmFwc2hvdFxuICAgICkge1xuICAgICAgICBpZiAodGhpcy5pc0ZhaWxlZFBlcm1pc3Npb25Qcm9wZXJ0eU9mUmVkaXJlY3RUbyhwZXJtaXNzaW9ucywgZmFpbGVkUGVybWlzc2lvbikpIHtcbiAgICAgICAgICAgIHRoaXMucmVkaXJlY3RUb0Fub3RoZXJSb3V0ZShwZXJtaXNzaW9ucy5yZWRpcmVjdFRvW2ZhaWxlZFBlcm1pc3Npb25dLCByb3V0ZSwgc3RhdGUsIGZhaWxlZFBlcm1pc3Npb24pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb248UmVkaXJlY3RUb0ZuPihwZXJtaXNzaW9ucy5yZWRpcmVjdFRvKSkge1xuICAgICAgICAgICAgICAgIHRoaXMucmVkaXJlY3RUb0Fub3RoZXJSb3V0ZShwZXJtaXNzaW9ucy5yZWRpcmVjdFRvLCByb3V0ZSwgc3RhdGUsIGZhaWxlZFBlcm1pc3Npb24pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlZGlyZWN0VG9Bbm90aGVyUm91dGUocGVybWlzc2lvbnMucmVkaXJlY3RUb1tERUZBVUxUX1JFRElSRUNUX0tFWV0sIHJvdXRlLCBzdGF0ZSwgZmFpbGVkUGVybWlzc2lvbik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGlzRmFpbGVkUGVybWlzc2lvblByb3BlcnR5T2ZSZWRpcmVjdFRvKHBlcm1pc3Npb25zOiBOZ3hQZXJtaXNzaW9uc0RhdGEsIGZhaWxlZFBlcm1pc3Npb246IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gKCEhcGVybWlzc2lvbnMucmVkaXJlY3RUbyAmJiBwZXJtaXNzaW9ucy5yZWRpcmVjdFRvW2ZhaWxlZFBlcm1pc3Npb25dKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNoZWNrT25seVBlcm1pc3Npb25zKFxuICAgICAgICBwdXJlUGVybWlzc2lvbnM6IE5neFBlcm1pc3Npb25zRGF0YSxcbiAgICAgICAgcm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QgfCBSb3V0ZSxcbiAgICAgICAgc3RhdGU/OiBSb3V0ZXJTdGF0ZVNuYXBzaG90XG4gICAgKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIGNvbnN0IHBlcm1pc3Npb25zOiBOZ3hQZXJtaXNzaW9uc0RhdGEgPSB7XG4gICAgICAgICAgICAuLi5wdXJlUGVybWlzc2lvbnNcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgdGhpcy5wZXJtaXNzaW9uc1NlcnZpY2UuaGFzUGVybWlzc2lvbihwZXJtaXNzaW9ucy5vbmx5KSxcbiAgICAgICAgICAgIHRoaXMucm9sZXNTZXJ2aWNlLmhhc09ubHlSb2xlcyhwZXJtaXNzaW9ucy5vbmx5KVxuICAgICAgICBdKS50aGVuKChbaGFzUGVybWlzc2lvbiwgaGFzUm9sZV0pID0+IHtcbiAgICAgICAgICAgIGlmIChoYXNQZXJtaXNzaW9uIHx8IGhhc1JvbGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHBlcm1pc3Npb25zLnJlZGlyZWN0VG8pIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlZGlyZWN0VG9Bbm90aGVyUm91dGUocGVybWlzc2lvbnMucmVkaXJlY3RUbywgcm91dGUsIHN0YXRlKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHBhc3NpbmdPbmx5UGVybWlzc2lvbnNWYWxpZGF0aW9uKFxuICAgICAgICBwZXJtaXNzaW9uczogTmd4UGVybWlzc2lvbnNEYXRhLFxuICAgICAgICByb3V0ZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCB8IFJvdXRlLFxuICAgICAgICBzdGF0ZT86IFJvdXRlclN0YXRlU25hcHNob3RcbiAgICApOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgKGlzRnVuY3Rpb248UmVkaXJlY3RUb0ZuPihwZXJtaXNzaW9ucy5yZWRpcmVjdFRvKVxuICAgICAgICAgICAgICAgIHx8IGlzUGxhaW5PYmplY3QocGVybWlzc2lvbnMucmVkaXJlY3RUbykgJiYgIXRoaXMuaXNSZWRpcmVjdGlvbldpdGhQYXJhbWV0ZXJzKHBlcm1pc3Npb25zLnJlZGlyZWN0VG8pKVxuICAgICAgICApIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm9ubHlSZWRpcmVjdENoZWNrKHBlcm1pc3Npb25zLCByb3V0ZSwgc3RhdGUpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLmNoZWNrT25seVBlcm1pc3Npb25zKHBlcm1pc3Npb25zLCByb3V0ZSwgc3RhdGUpO1xuICAgIH1cbn1cbiJdfQ==